<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HR Attendance Analyzer (Daily Range Summary)</title>

  <!-- SheetJS (XLS/XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#8ea0c6;--text:#e9efff;--accent:#7aa2ff;--good:#33d17a;--warn:#ffcc00;--bad:#ff5c7a;}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#070a14 100%);color:var(--text);}
    .wrap{max-width:1280px;margin:0 auto;padding:24px;}
    h1{margin:0 0 6px 0;font-size:22px;}
    p{margin:0 0 14px 0;color:var(--muted);line-height:1.45;}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(122,162,255,.18);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .drop{border:2px dashed rgba(122,162,255,.35);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:center;justify-content:space-between;}
    .drop .left{display:flex;gap:14px;align-items:center;}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(122,162,255,.12);border:1px solid rgba(122,162,255,.25);padding:6px 10px;border-radius:999px;color:var(--text);font-size:12px;}
    .btn{appearance:none;border:0;border-radius:14px;padding:10px 12px;background:var(--accent);color:#0b1020;font-weight:800;cursor:pointer;}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(122,162,255,.35);}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input,select{width:100%;padding:10px 10px;border-radius:14px;border:1px solid rgba(122,162,255,.25);background:rgba(8,12,26,.55);color:var(--text);}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    @media (max-width: 980px){.three{grid-template-columns:1fr;} .two{grid-template-columns:1fr;}}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    @media (max-width: 980px){.kpi{grid-template-columns:repeat(2,1fr);} }
    .kpi .box{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;}
    .kpi .n{font-size:18px;font-weight:900;margin-top:4px;}
    .tag{font-size:12px;color:var(--muted)}
    .bd{color:var(--bad)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.08);}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px;vertical-align:top;white-space:nowrap;}
    th{background:rgba(255,255,255,.04);text-align:left;color:#cfe0ff;position:sticky;top:0;z-index:2;}
    tr:last-child td{border-bottom:0;}
    .scroll{max-height:460px;overflow:auto;border-radius:14px;}
    .small{font-size:12px;color:var(--muted)}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;font-weight:800;font-size:12px;color:#cfe0ff;}
    .tab.active{border-color:rgba(122,162,255,.55);background:rgba(122,162,255,.14);}

    /* Calendar cell styles */
    .c1{background:rgba(51,209,122,.12);}   /* 1 day */
    .c05{background:rgba(255,204,0,.14);}  /* 0.5 day */
    .c0{background:rgba(255,92,122,.12);}  /* 0 */
    .cab{background:rgba(255,92,122,.18);} /* abnormal */
    .ch{background:rgba(255,255,255,.06);} /* weekend/holiday */

    .sticky-col{position:sticky;left:0;z-index:3;background:rgba(18,26,51,.98);} /* for first column */
    .sticky-col2{position:sticky;left:120px;z-index:3;background:rgba(18,26,51,.98);} /* second */
    .sticky-col3{position:sticky;left:280px;z-index:3;background:rgba(18,26,51,.98);} /* third */
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HR Attendance Analyzer ‚Äî ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</h1>
    <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö <b>‚Äú‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‚Äù</b> ‡πÉ‡∏´‡πâ HR ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äì‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πÅ‡∏Å‡∏ô</p>

    <div class="grid">
      <div class="card">
        <div class="drop" id="dropZone">
          <div class="left">
            <div class="pill">üìé Drag & Drop ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            <div class="small" id="fileName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
          </div>
          <div class="row">
            <input id="fileInput" type="file" accept=".xls,.xlsx" style="display:none" />
            <button class="btn secondary" id="pickBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            <button class="btn" id="downloadBtn" disabled>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (XLSX)</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpi">
          <div class="box"><div class="tag">‡πÅ‡∏ñ‡∏ß‡∏î‡∏¥‡∏ö (Raw)</div><div class="n" id="kRaw">‚Äî</div></div>
          <div class="box"><div class="tag">‡πÅ‡∏ñ‡∏ß Daily</div><div class="n" id="kDaily">‚Äî</div></div>
          <div class="box"><div class="tag">‡∏Ñ‡∏ô (Unique)</div><div class="n" id="kPeople">‚Äî</div></div>
          <div class="box"><div class="tag">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="n bd" id="kBad">‚Äî</div></div>
        </div>

        <div class="hr"></div>

        <div class="tabs">
          <button class="tab active" id="tabDaily">Daily</button>
          <button class="tab" id="tabSummary">Summary</button>
          <button class="tab" id="tabCalendar">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
        </div>

        <div class="scroll" style="margin-top:10px;">
          <table>
            <thead><tr id="prevHead"></tr></thead>
            <tbody id="prevBody"><tr><td class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:8px;">
          ‡πÉ‡∏ô ‚Äú‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‚Äù ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô <code>1</code>, <code>0.5</code>, <code>0</code> ‡∏´‡∏£‡∏∑‡∏≠ <code>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</code> (‡∏≠‡∏¥‡∏á logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Daily)
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:8px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>

        <div style="font-weight:800;margin:6px 0 6px 0;color:#cfe0ff;">1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏µ‡∏ó</div>
        <div class="row">
          <select id="sheetSelect" disabled></select>
          <button class="btn secondary" id="loadSheetBtn" disabled>‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó</button>
        </div>
        <div class="small" style="margin-top:6px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: <code>AC-No</code>, <code>Name</code>, <code>Department</code>, <code>Date</code>, <code>Time</code> (‡∏£‡∏ß‡∏° alias ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ö‡∏≤‡∏á‡πÅ‡∏ö‡∏ö)</div>

        <div class="hr"></div>

        <div style="font-weight:800;margin-bottom:6px;color:#cfe0ff;">2) ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‚Äú‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‚Äù</div>
        <div class="two">
          <div>
            <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
            <input id="rangeStart" type="date" />
          </div>
          <div>
            <label>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
            <input id="rangeEnd" type="date" />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <label style="display:flex;align-items:center;gap:8px;margin:0;color:var(--muted);">
            <input id="weekendAsHoliday" type="checkbox" checked />
            ‡∏ñ‡πâ‡∏≤ ‚Äú‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‚Äù ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô <b>‡∏Ç</b> (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
          </label>
        </div>

        <div class="hr"></div>

        <div style="font-weight:800;margin-bottom:6px;color:#cfe0ff;">3) ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡∏¢</div>
        <div class="three">
          <div>
            <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
            <input id="start" type="time" value="08:00" />
          </div>
          <div>
            <label>‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô) ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
            <input id="lateNoDed" type="time" value="08:01" />
          </div>
          <div>
            <label>‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
            <input id="lateDed" type="time" value="08:05" />
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:800;margin-bottom:6px;color:#cfe0ff;">4) ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
        <div class="two">
          <div>
            <label>‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî 540 = 9 ‡∏ä‡∏°.</label>
            <input id="fullDayMin" type="number" value="540" />
          </div>
          <div>
            <label>‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî 240 = 4 ‡∏ä‡∏°.</label>
            <input id="halfDayMin" type="number" value="240" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="small">
          <div style="font-weight:900;color:#cfe0ff;margin-bottom:6px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‚Äú‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡∏õ‡πà‡∏ß‡∏¢/‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô/‡∏•‡∏≤‚Äù</div>
          <div>‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤ (‡∏Å/‡∏õ/‡∏û/‡∏•‡∏≤) ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á <b>0</b> (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô) ‡πÄ‡∏õ‡πá‡∏ô placeholder ‡∏ï‡∏≤‡∏° logic ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ ‚Äú‡∏≠‡∏¥‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏≤/‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏Å‡∏∞‚Äù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // =====================
  // Helpers (match React reference)
  // =====================
  const pad2 = (n) => String(n).padStart(2, '0');

  function parseThaiOrAnyDate(v) {
    if (!v && v !== 0) return null;
    if (v instanceof Date && !isNaN(v.getTime())) return v;

    if (typeof v === 'number') {
      const d = XLSX.SSF.parse_date_code(v);
      if (d) return new Date(d.y, d.m - 1, d.d);
    }

    const s = String(v).trim();
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if (m) {
      const dd = Number(m[1]);
      const mm = Number(m[2]);
      let yy = Number(m[3]);
      if (yy < 100) yy += 2000;
      const d = new Date(yy, mm - 1, dd);
      return isNaN(d.getTime()) ? null : d;
    }

    const d2 = new Date(s);
    return isNaN(d2.getTime()) ? null : d2;
  }

  function parseTimesCell(v) {
    if (v == null || v === '') return [];
    const s = String(v);
    const parts = s
      .split(/\s+/)
      .map((p) => p.replace(/[^0-9:]/g, ''))
      .filter(Boolean);

    const times = [];
    for (const p of parts) {
      const m = p.match(/^(\d{1,2}):(\d{2})$/);
      if (!m) continue;
      const hh = Number(m[1]);
      const mm = Number(m[2]);
      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) continue;
      times.push({ hh, mm, raw: `${pad2(hh)}:${pad2(mm)}` });
    }
    times.sort((a, b) => a.hh * 60 + a.mm - (b.hh * 60 + b.mm));
    return times;
  }

  function timeToMinutes(t) { return t.hh * 60 + t.mm; }

  function minutesToHHMM(mins) {
    if (mins == null || Number.isNaN(mins)) return '';
    const h = Math.floor(mins / 60);
    const m = Math.round(mins % 60);
    return `${pad2(h)}:${pad2(m)}`;
  }

  function formatDate(d) {
    if (!d) return '';
    return `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}/${d.getFullYear()}`;
  }

  function keyDate(d) {
    if (!d) return '';
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }

  function classifyLateText(inTime, policy) {
    if (!inTime) return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
    const toMin = (hhmm) => {
      const [h, m] = hhmm.split(':').map(Number);
      return h * 60 + m;
    };
    const start = toMin(policy.start);
    const noDeductFrom = toMin(policy.lateNoDeductFrom);
    const deductFrom = toMin(policy.lateDeductFrom);
    const m = timeToMinutes(inTime);

    if (m <= start) return '‡∏õ‡∏Å‡∏ï‡∏¥';
    if (m >= deductFrom) return '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô';
    if (m >= noDeductFrom) return '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥';
    return '‡∏õ‡∏Å‡∏ï‡∏¥';
  }

  function normalizeRow(row) {
    const pick = (keys) => {
      for (const k of keys) {
        if (row[k] != null && row[k] !== '') return row[k];
      }
      return null;
    };

    const acNo = pick(['AC-No', 'AC No', 'ACNo', '‡∏£‡∏´‡∏±‡∏™', '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'EmpCode']);
    const name = pick(['Name', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'Employee', 'EmpName']);
    const dept = pick(['Department', '‡πÅ‡∏ú‡∏ô‡∏Å', '‡∏ù‡πà‡∏≤‡∏¢', 'Dept']);
    const dateVal = pick(['Date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô', 'WorkDate']);
    const timeVal = pick(['Time', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏™‡πÅ‡∏Å‡∏ô', 'Scan', 'Check']);

    const date = parseThaiOrAnyDate(dateVal);
    const times = parseTimesCell(timeVal);

    return {
      acNo: acNo != null ? String(acNo).trim() : '',
      name: name != null ? String(name).trim() : '',
      dept: dept != null ? String(dept).trim() : '',
      date,
      times,
    };
  }

  function buildNote(workStatus, lateStatus, scanType) {
    const notes = [];
    if (scanType === '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥') notes.push('‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤=‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å, ‡∏≠‡∏≠‡∏Å=‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)');
    if (scanType === '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß') notes.push('‡∏Ç‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å');
    if (scanType === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô') notes.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πÅ‡∏Å‡∏ô (‡∏≠‡∏≤‡∏à‡∏•‡∏≤/‡∏´‡∏¢‡∏∏‡∏î/‡∏Ç‡∏≤‡∏î)');
    if (workStatus === '0.5') notes.push('‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô');
    if (workStatus === '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' && scanType !== '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß') notes.push('‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå');
    if (lateStatus === '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô') notes.push('‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô');
    if (lateStatus === '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥') notes.push('‡∏™‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô');
    return notes.join(' | ');
  }

  function buildDaily(records, policy, workRules) {
    const map = new Map();
    for (const r of records) {
      if (!r.date) continue;
      const k = `${r.acNo}||${r.name}||${r.dept}||${keyDate(r.date)}`;
      if (!map.has(k)) map.set(k, { ...r, times: [...(r.times || [])] });
      else {
        const cur = map.get(k);
        cur.times.push(...(r.times || []));
        cur.times.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
        map.set(k, cur);
      }
    }

    const daily = [];
    for (const v of map.values()) {
      const times = v.times || [];

      let inT = null;
      let outT = null;
      let scanType = '‡∏õ‡∏Å‡∏ï‡∏¥';

      if (times.length === 0) {
        scanType = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô';
      } else if (times.length === 1) {
        scanType = '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
        inT = times[0];
        outT = times[0];
      } else {
        inT = times[0];
        outT = times[times.length - 1];
        scanType = times.length > 2 ? '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥';
      }

      let durationMin = null;
      if (times.length >= 2 && inT && outT) {
        durationMin = Math.max(0, timeToMinutes(outT) - timeToMinutes(inT));
      }

      let workStatus = '0';
      if (times.length === 0) {
        workStatus = '0';
      } else if (times.length === 1) {
        workStatus = '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
      } else {
        if (durationMin >= workRules.fullDayMin) workStatus = '1';
        else if (durationMin >= workRules.halfDayMin) workStatus = '0.5';
        else workStatus = '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
      }

      const lateStatus = scanType === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : classifyLateText(inT, policy);

      daily.push({
        '‡∏£‡∏´‡∏±‡∏™': v.acNo,
        '‡∏ä‡∏∑‡πà‡∏≠': v.name,
        '‡πÅ‡∏ú‡∏ô‡∏Å': v.dept,
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': formatDate(v.date),
        '‡πÄ‡∏Ç‡πâ‡∏≤': inT ? inT.raw : '',
        '‡∏≠‡∏≠‡∏Å': outT ? outT.raw : '',
        '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á(‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å)': durationMin != null ? minutesToHHMM(durationMin) : '',
        '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô': workStatus,
        '‡∏™‡∏≤‡∏¢': lateStatus,
        '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô': scanType,
        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': buildNote(workStatus, lateStatus, scanType),
      });
    }

    daily.sort((a, b) => (a['‡∏ä‡∏∑‡πà‡∏≠'] || '').localeCompare(b['‡∏ä‡∏∑‡πà‡∏≠'] || '', 'th') || (a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || '').localeCompare(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || ''));
    return daily;
  }

  function buildSummary(dailyRows) {
    const m = new Map();
    const inc = (o, k, v = 1) => (o[k] = (o[k] || 0) + v);

    for (const r of dailyRows) {
      const key = `${r['‡∏£‡∏´‡∏±‡∏™']}||${r['‡∏ä‡∏∑‡πà‡∏≠']}||${r['‡πÅ‡∏ú‡∏ô‡∏Å']}`;
      if (!m.has(key)) {
        m.set(key, {
          '‡∏£‡∏´‡∏±‡∏™': r['‡∏£‡∏´‡∏±‡∏™'],
          '‡∏ä‡∏∑‡πà‡∏≠': r['‡∏ä‡∏∑‡πà‡∏≠'],
          '‡πÅ‡∏ú‡∏ô‡∏Å': r['‡πÅ‡∏ú‡∏ô‡∏Å'],
          '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô=1': 0,
          '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô=0.5': 0,
          '‡∏Ç‡∏≤‡∏î/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô=0': 0,
          '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥': 0,
          '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥': 0,
          '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô': 0,
          '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥': 0,
          '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß': 0,
        });
      }
      const s = m.get(key);

      if (r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '1') inc(s, '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô=1');
      else if (r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '0.5') inc(s, '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô=0.5');
      else if (r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '0') inc(s, '‡∏Ç‡∏≤‡∏î/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô=0');
      else inc(s, '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');

      if (r['‡∏™‡∏≤‡∏¢'] === '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥') inc(s, '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥');
      if (r['‡∏™‡∏≤‡∏¢'] === '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô') inc(s, '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô');

      if (r['‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô'] === '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥') inc(s, '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥');
      if (r['‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô'] === '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß') inc(s, '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß');

      m.set(key, s);
    }

    const out = Array.from(m.values());
    out.sort((a, b) => (b['‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'] || 0) - (a['‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'] || 0));
    return out;
  }

  // =====================
  // New: Daily Range Calendar Table
  // =====================
  function parseDDMMYYYY(s){
    const m = String(s||'').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return null;
    const dd=+m[1], mm=+m[2], yy=+m[3];
    const d=new Date(yy, mm-1, dd);
    return isNaN(d.getTime())?null:d;
  }

  function isoDate(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function isWeekend(d){
    const day = d.getDay(); // 0 sun, 6 sat
    return day === 0 || day === 6;
  }

  function dateRange(start, end){
    const out=[];
    if(!start || !end) return out;
    const a=new Date(start.getFullYear(), start.getMonth(), start.getDate());
    const b=new Date(end.getFullYear(), end.getMonth(), end.getDate());
    if(a>b) return out;
    for(let d=a; d<=b; d=new Date(d.getFullYear(), d.getMonth(), d.getDate()+1)){
      out.push(new Date(d));
    }
    return out;
  }

  function numWork(v){
    if(v==='1') return 1;
    if(v==='0.5') return 0.5;
    return 0;
  }

  function buildCalendarTable(dailyRows, startDate, endDate, weekendHoliday){
    const dates = dateRange(startDate, endDate);
    if(!dates.length) return {rows:[], dates:[]};

    // index daily by empKey + isoDate
    const byEmp = new Map();
    for(const r of dailyRows){
      const empKey = `${r['‡∏£‡∏´‡∏±‡∏™']}||${r['‡∏ä‡∏∑‡πà‡∏≠']}||${r['‡πÅ‡∏ú‡∏ô‡∏Å']}`;
      const d = parseDDMMYYYY(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
      if(!d) continue;
      const dk = isoDate(d);
      if(!byEmp.has(empKey)) byEmp.set(empKey, {info:{‡∏£‡∏´‡∏±‡∏™:r['‡∏£‡∏´‡∏±‡∏™'], ‡∏ä‡∏∑‡πà‡∏≠:r['‡∏ä‡∏∑‡πà‡∏≠'], ‡πÅ‡∏ú‡∏ô‡∏Å:r['‡πÅ‡∏ú‡∏ô‡∏Å']}, day:new Map()});
      byEmp.get(empKey).day.set(dk, r);
    }

    // build rows
    const rows=[];
    for(const v of byEmp.values()){
      const row={};
      row['‡∏£‡∏´‡∏±‡∏™']=v.info['‡∏£‡∏´‡∏±‡∏™'];
      row['‡∏ä‡∏∑‡πà‡∏≠']=v.info['‡∏ä‡∏∑‡πà‡∏≠'];
      row['‡πÅ‡∏ú‡∏ô‡∏Å']=v.info['‡πÅ‡∏ú‡∏ô‡∏Å'];

      let totalWork=0;
      let lateCount=0;
      let lateDed=0;
      let abnormal=0;
      let noScan0=0;

      for(const d of dates){
        const dk=isoDate(d);
        const col=pad2(d.getDate()); // show day-of-month like your table

        const rec = v.day.get(dk);
        let val='0';
        if(rec){
          val = rec['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'];
          if(val==='‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥') abnormal += 1;
          if(rec['‡∏™‡∏≤‡∏¢']==='‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥' || rec['‡∏™‡∏≤‡∏¢']==='‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô') lateCount += 1;
          if(rec['‡∏™‡∏≤‡∏¢']==='‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô') lateDed += 1;
        }else{
          // no record that day
          if(weekendHoliday && isWeekend(d)){
            val = '‡∏Ç'; // holiday mark
          }else{
            val = '0';
            noScan0 += 1;
          }
        }

        totalWork += numWork(val);
        row[col] = val;
      }

      row['‡∏™‡∏≤‡∏¢'] = lateCount;
      row['‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'] = lateDed;
      row['‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥'] = abnormal;
      row['0(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô)'] = noScan0;
      row['‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] = totalWork;
      rows.push(row);
    }

    rows.sort((a,b)=>(a['‡∏ä‡∏∑‡πà‡∏≠']||'').localeCompare(b['‡∏ä‡∏∑‡πà‡∏≠']||'', 'th'));

    // totals row per day
    const totalRow={‡∏£‡∏´‡∏±‡∏™:'', ‡∏ä‡∏∑‡πà‡∏≠:'‡∏£‡∏ß‡∏°', ‡πÅ‡∏ú‡∏ô‡∏Å:''};
    let sumWorkAll=0, sumLate=0, sumLateDed=0, sumAb=0, sumNoScan=0;
    for(const d of dates){
      const col=pad2(d.getDate());
      let s=0;
      for(const r of rows){
        const v = r[col];
        if(v==='1') s+=1;
        else if(v==='0.5') s+=0.5;
      }
      totalRow[col]=s;
    }
    for(const r of rows){
      sumWorkAll += Number(r['‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô']||0);
      sumLate += Number(r['‡∏™‡∏≤‡∏¢']||0);
      sumLateDed += Number(r['‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô']||0);
      sumAb += Number(r['‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥']||0);
      sumNoScan += Number(r['0(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô)']||0);
    }
    totalRow['‡∏™‡∏≤‡∏¢']=sumLate;
    totalRow['‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô']=sumLateDed;
    totalRow['‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥']=sumAb;
    totalRow['0(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô)']=sumNoScan;
    totalRow['‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô']=sumWorkAll;

    return {rows:[...rows, totalRow], dates};
  }

  function cellClassForCalendar(v){
    if(v==='1') return 'c1';
    if(v==='0.5') return 'c05';
    if(v==='0') return 'c0';
    if(v==='‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥') return 'cab';
    if(v==='‡∏Ç') return 'ch';
    return '';
  }

  function downloadXLSX({ sheetName, dailyRows, summaryRows, calendarRows }) {
    const wb = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dailyRows), 'Daily');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), 'Summary');
    if(calendarRows && calendarRows.length){
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(calendarRows), 'Calendar');
    }

    XLSX.writeFile(wb, `HR_Attendance_${sheetName || 'sheet'}.xlsx`);
  }

  // =====================
  // UI State
  // =====================
  const $ = (id) => document.getElementById(id);
  let wb = null;
  let currentSheet = '';
  let rawRows = [];
  let dailyRows = [];
  let summaryRows = [];
  let calendarRows = [];
  let calendarDates = [];
  let activeTab = 'Daily';

  function setFileName(name){ $('fileName').textContent = name || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'; }

  function setTab(name){
    activeTab = name;
    $('tabDaily').classList.toggle('active', name === 'Daily');
    $('tabSummary').classList.toggle('active', name === 'Summary');
    $('tabCalendar').classList.toggle('active', name === 'Calendar');
    renderTable();
  }

  function getPolicy(){
    return {
      start: $('start').value || '08:00',
      lateNoDeductFrom: $('lateNoDed').value || '08:01',
      lateDeductFrom: $('lateDed').value || '08:05',
    };
  }

  function getWorkRules(){
    return {
      fullDayMin: Number($('fullDayMin').value || 540),
      halfDayMin: Number($('halfDayMin').value || 240),
    };
  }

  function getRangeDates(){
    const s = $('rangeStart').value;
    const e = $('rangeEnd').value;
    const sd = s ? new Date(s+"T00:00:00") : null;
    const ed = e ? new Date(e+"T00:00:00") : null;
    return {sd, ed};
  }

  function updateKPIs(){
    $('kRaw').textContent = rawRows.length ? String(rawRows.length) : '‚Äî';
    $('kDaily').textContent = dailyRows.length ? String(dailyRows.length) : '‚Äî';
    const people = new Set(dailyRows.map(r => `${r['‡∏£‡∏´‡∏±‡∏™']}||${r['‡∏ä‡∏∑‡πà‡∏≠']}||${r['‡πÅ‡∏ú‡∏ô‡∏Å']}`));
    $('kPeople').textContent = dailyRows.length ? String(people.size) : '‚Äî';
    const bad = dailyRows.filter(r => r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥').length;
    $('kBad').textContent = dailyRows.length ? String(bad) : '‚Äî';
  }

  function recomputeCalendar(){
    const {sd, ed} = getRangeDates();
    const weekendHoliday = $('weekendAsHoliday').checked;
    if(!sd || !ed){
      calendarRows = [];
      calendarDates = [];
      return;
    }
    const out = buildCalendarTable(dailyRows, sd, ed, weekendHoliday);
    calendarRows = out.rows;
    calendarDates = out.dates;
  }

  function renderTable(){
    const head = $('prevHead');
    const body = $('prevBody');
    head.innerHTML='';
    body.innerHTML='';

    let rows = dailyRows;
    if(activeTab==='Summary') rows = summaryRows;
    if(activeTab==='Calendar') rows = calendarRows;

    if(!rows.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.className='small';
      td.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå/‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó/‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';
      td.colSpan = 40;
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    const cols = Object.keys(rows[0]);

    // header
    for(const c of cols){
      const th = document.createElement('th');
      th.textContent = c;
      // sticky for calendar first 3 columns
      if(activeTab==='Calendar'){
        if(c==='‡∏£‡∏´‡∏±‡∏™') th.classList.add('sticky-col');
        if(c==='‡∏ä‡∏∑‡πà‡∏≠') th.classList.add('sticky-col2');
        if(c==='‡πÅ‡∏ú‡∏ô‡∏Å') th.classList.add('sticky-col3');
      }
      head.appendChild(th);
    }

    const sample = (activeTab==='Calendar') ? rows : rows.slice(0, 60);
    for(const r of sample){
      const tr = document.createElement('tr');
      for(const c of cols){
        const td = document.createElement('td');
        const v = r[c] ?? '';
        td.textContent = v;

        if(activeTab==='Calendar'){
          if(c==='‡∏£‡∏´‡∏±‡∏™') td.classList.add('sticky-col');
          if(c==='‡∏ä‡∏∑‡πà‡∏≠') td.classList.add('sticky-col2');
          if(c==='‡πÅ‡∏ú‡∏ô‡∏Å') td.classList.add('sticky-col3');

          // day columns are "01".."31"
          if(/^\d{2}$/.test(c)){
            td.classList.add(cellClassForCalendar(String(v)));
          }
        }

        tr.appendChild(td);
      }
      body.appendChild(tr);
    }
  }

  function recompute(){
    const normalized = rawRows.map(normalizeRow);
    dailyRows = buildDaily(normalized, getPolicy(), getWorkRules());
    summaryRows = buildSummary(dailyRows);
    recomputeCalendar();

    $('downloadBtn').disabled = dailyRows.length === 0;
    updateKPIs();
    renderTable();
  }

  function loadSheet(){
    if(!wb) return;
    currentSheet = $('sheetSelect').value;
    if(!currentSheet) return;
    const ws = wb.Sheets[currentSheet];
    rawRows = XLSX.utils.sheet_to_json(ws, { defval: null });

    // auto set range if empty: min/max dates from normalized rows
    const norm = rawRows.map(normalizeRow).filter(r=>r.date);
    if(norm.length){
      const ds = norm.map(r=> new Date(r.date.getFullYear(), r.date.getMonth(), r.date.getDate()));
      ds.sort((a,b)=>a-b);
      const min = ds[0];
      const max = ds[ds.length-1];
      if(!$('rangeStart').value) $('rangeStart').value = isoDate(min);
      if(!$('rangeEnd').value) $('rangeEnd').value = isoDate(max);
    }

    recompute();
  }

  async function onPickFile(file){
    if(!file) return;
    setFileName(file.name);
    const buf = await file.arrayBuffer();
    wb = XLSX.read(buf, { type: 'array' });

    $('sheetSelect').innerHTML='';
    for(const s of wb.SheetNames){
      const opt = document.createElement('option');
      opt.value = s; opt.textContent = s;
      $('sheetSelect').appendChild(opt);
    }

    currentSheet = wb.SheetNames[0] || '';
    $('sheetSelect').value = currentSheet;
    $('sheetSelect').disabled = !currentSheet;
    $('loadSheetBtn').disabled = !currentSheet;

    loadSheet();
  }

  function downloadOneClick(){
    if(!dailyRows.length){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå/‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    downloadXLSX({ sheetName: currentSheet, dailyRows, summaryRows, calendarRows });
  }

  // =====================
  // Wire UI
  // =====================
  $('pickBtn').addEventListener('click', ()=> $('fileInput').click());
  $('fileInput').addEventListener('change', (e)=> onPickFile(e.target.files?.[0]));
  $('loadSheetBtn').addEventListener('click', ()=> loadSheet());
  $('downloadBtn').addEventListener('click', ()=> downloadOneClick());

  $('sheetSelect').addEventListener('change', ()=> loadSheet());

  for(const id of ['start','lateNoDed','lateDed','fullDayMin','halfDayMin','rangeStart','rangeEnd','weekendAsHoliday']){
    $(id).addEventListener('change', ()=> { recomputeCalendar(); renderTable(); });
    if($(id).tagName === 'INPUT') $(id).addEventListener('keyup', ()=> { recomputeCalendar(); renderTable(); });
  }

  $('tabDaily').addEventListener('click', ()=> setTab('Daily'));
  $('tabSummary').addEventListener('click', ()=> setTab('Summary'));
  $('tabCalendar').addEventListener('click', ()=> setTab('Calendar'));

  const dz = $('dropZone');
  dz.addEventListener('dragover', (e)=>{e.preventDefault();dz.style.borderColor='rgba(122,162,255,.75)';});
  dz.addEventListener('dragleave', ()=>{dz.style.borderColor='rgba(122,162,255,.35)';});
  dz.addEventListener('drop', (e)=>{
    e.preventDefault();
    dz.style.borderColor='rgba(122,162,255,.35)';
    const f = e.dataTransfer.files?.[0];
    if(f) onPickFile(f);
  });

  renderTable();
</script>
</body>
</html>
