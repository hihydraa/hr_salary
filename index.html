<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HR Attendance Analyzer (HTML)</title>

  <!-- SheetJS (XLS/XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#8ea0c6;--text:#e9efff;--accent:#7aa2ff;--good:#33d17a;--warn:#ffcc00;--bad:#ff5c7a;}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#070a14 100%);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:24px;}
    h1{margin:0 0 6px 0;font-size:22px;}
    p{margin:0 0 14px 0;color:var(--muted);line-height:1.45;}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(122,162,255,.18);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .drop{border:2px dashed rgba(122,162,255,.35);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:center;justify-content:space-between;}
    .drop .left{display:flex;gap:14px;align-items:center;}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(122,162,255,.12);border:1px solid rgba(122,162,255,.25);padding:6px 10px;border-radius:999px;color:var(--text);font-size:12px;}
    .btn{appearance:none;border:0;border-radius:14px;padding:10px 12px;background:var(--accent);color:#0b1020;font-weight:800;cursor:pointer;}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(122,162,255,.35);}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input,select{width:100%;padding:10px 10px;border-radius:14px;border:1px solid rgba(122,162,255,.25);background:rgba(8,12,26,.55);color:var(--text);}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    @media (max-width: 980px){.three{grid-template-columns:1fr;} .two{grid-template-columns:1fr;}}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    @media (max-width: 980px){.kpi{grid-template-columns:repeat(2,1fr);} }
    .kpi .box{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;}
    .kpi .n{font-size:18px;font-weight:900;margin-top:4px;}
    .tag{font-size:12px;color:var(--muted)}
    .bd{color:var(--bad)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.08);}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px;vertical-align:top;}
    th{background:rgba(255,255,255,.04);text-align:left;color:#cfe0ff;position:sticky;top:0;}
    tr:last-child td{border-bottom:0;}
    .scroll{max-height:420px;overflow:auto;border-radius:14px;}
    .small{font-size:12px;color:var(--muted)}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;font-weight:700;font-size:12px;color:#cfe0ff;}
    .tab.active{border-color:rgba(122,162,255,.55);background:rgba(122,162,255,.14);}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HR Attendance Analyzer (Logic matched)</h1>
    <p>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á logic ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î React ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <code>Time</code> ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Üí ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤=‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏£‡∏Å ‡∏≠‡∏≠‡∏Å=‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‚Üí ‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á Daily + Summary ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î XLSX ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>

    <div class="grid">
      <div class="card">
        <div class="drop" id="dropZone">
          <div class="left">
            <div class="pill">üìé Drag & Drop ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            <div class="small" id="fileName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
          </div>
          <div class="row">
            <input id="fileInput" type="file" accept=".xls,.xlsx" style="display:none" />
            <button class="btn secondary" id="pickBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            <button class="btn" id="downloadBtn" disabled>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (XLSX)</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpi">
          <div class="box"><div class="tag">‡πÅ‡∏ñ‡∏ß‡∏î‡∏¥‡∏ö (Raw)</div><div class="n" id="kRaw">‚Äî</div></div>
          <div class="box"><div class="tag">‡πÅ‡∏ñ‡∏ß Daily</div><div class="n" id="kDaily">‚Äî</div></div>
          <div class="box"><div class="tag">‡∏Ñ‡∏ô (Unique)</div><div class="n" id="kPeople">‚Äî</div></div>
          <div class="box"><div class="tag">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="n bd" id="kBad">‚Äî</div></div>
        </div>

        <div class="hr"></div>

        <div class="tabs">
          <button class="tab active" id="tabDaily">Daily</button>
          <button class="tab" id="tabSummary">Summary</button>
        </div>

        <div class="scroll" style="margin-top:10px;">
          <table>
            <thead><tr id="prevHead"></tr></thead>
            <tbody id="prevBody"><tr><td class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:8px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>

        <div style="font-weight:800;margin:6px 0 6px 0;color:#cfe0ff;">1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏µ‡∏ó</div>
        <div class="row">
          <select id="sheetSelect" disabled></select>
          <button class="btn secondary" id="loadSheetBtn" disabled>‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó</button>
        </div>
        <div class="small" style="margin-top:6px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: <code>AC-No</code>, <code>Name</code>, <code>Department</code>, <code>Date</code>, <code>Time</code> (‡∏£‡∏ß‡∏° alias ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ö‡∏≤‡∏á‡πÅ‡∏ö‡∏ö)</div>

        <div class="hr"></div>

        <div style="font-weight:800;margin-bottom:6px;color:#cfe0ff;">2) ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡∏¢</div>
        <div class="three">
          <div>
            <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
            <input id="start" type="time" value="08:00" />
          </div>
          <div>
            <label>‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô) ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
            <input id="lateNoDed" type="time" value="08:01" />
          </div>
          <div>
            <label>‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
            <input id="lateDed" type="time" value="08:05" />
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:800;margin-bottom:6px;color:#cfe0ff;">3) ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
        <div class="two">
          <div>
            <label>‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî 540 = 9 ‡∏ä‡∏°.</label>
            <input id="fullDayMin" type="number" value="540" />
          </div>
          <div>
            <label>‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî 240 = 4 ‡∏ä‡∏°.</label>
            <input id="halfDayMin" type="number" value="240" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="small">
          <div style="font-weight:900;color:#cfe0ff;margin-bottom:6px;">Logic ‡∏™‡∏£‡∏∏‡∏õ</div>
          <ul style="margin:0;padding-left:18px;line-height:1.55;">
            <li><b>Time</b> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <code>08:04 18:50</code>, <code>08:05, 17:03</code>, <code>08:04 12:00 13:00 18:50</code></li>
            <li>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô / ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡∏õ‡∏Å‡∏ï‡∏¥ (2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) / ‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥ (&gt;2)</li>
            <li>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô=0, ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß=‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥, 2+ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡∏≤‡∏ó‡∏µ (‡∏≠‡∏≠‡∏Å-‡πÄ‡∏Ç‡πâ‡∏≤) ‚Üí 1/0.5/‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</li>
            <li>‡∏™‡∏≤‡∏¢: ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏±‡∏ö Start/NoDeductFrom/DeductFrom</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
  // =====================
  // Helpers (match React reference)
  // =====================
  const pad2 = (n) => String(n).padStart(2, '0');

  function parseThaiOrAnyDate(v) {
    if (!v && v !== 0) return null;
    if (v instanceof Date && !isNaN(v.getTime())) return v;

    if (typeof v === 'number') {
      const d = XLSX.SSF.parse_date_code(v);
      if (d) return new Date(d.y, d.m - 1, d.d);
    }

    const s = String(v).trim();
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if (m) {
      const dd = Number(m[1]);
      const mm = Number(m[2]);
      let yy = Number(m[3]);
      if (yy < 100) yy += 2000;
      const d = new Date(yy, mm - 1, dd);
      return isNaN(d.getTime()) ? null : d;
    }

    const d2 = new Date(s);
    return isNaN(d2.getTime()) ? null : d2;
  }

  function parseTimesCell(v) {
    if (v == null || v === '') return [];
    const s = String(v);
    const parts = s
      .split(/\s+/)
      .map((p) => p.replace(/[^0-9:]/g, ''))
      .filter(Boolean);

    const times = [];
    for (const p of parts) {
      const m = p.match(/^(\d{1,2}):(\d{2})$/);
      if (!m) continue;
      const hh = Number(m[1]);
      const mm = Number(m[2]);
      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) continue;
      times.push({ hh, mm, raw: `${pad2(hh)}:${pad2(mm)}` });
    }
    times.sort((a, b) => a.hh * 60 + a.mm - (b.hh * 60 + b.mm));
    return times;
  }

  function timeToMinutes(t) {
    return t.hh * 60 + t.mm;
  }

  function minutesToHHMM(mins) {
    if (mins == null || Number.isNaN(mins)) return '';
    const h = Math.floor(mins / 60);
    const m = Math.round(mins % 60);
    return `${pad2(h)}:${pad2(m)}`;
  }

  function formatDate(d) {
    if (!d) return '';
    return `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}/${d.getFullYear()}`;
  }

  function keyDate(d) {
    if (!d) return '';
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }

  function classifyLateText(inTime, policy) {
    if (!inTime) return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
    const toMin = (hhmm) => {
      const [h, m] = hhmm.split(':').map(Number);
      return h * 60 + m;
    };
    const start = toMin(policy.start);
    const noDeductFrom = toMin(policy.lateNoDeductFrom);
    const deductFrom = toMin(policy.lateDeductFrom);
    const m = timeToMinutes(inTime);

    if (m <= start) return '‡∏õ‡∏Å‡∏ï‡∏¥';
    if (m >= deductFrom) return '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô';
    if (m >= noDeductFrom) return '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥';
    return '‡∏õ‡∏Å‡∏ï‡∏¥';
  }

  function normalizeRow(row) {
    const pick = (keys) => {
      for (const k of keys) {
        if (row[k] != null && row[k] !== '') return row[k];
      }
      return null;
    };

    const acNo = pick(['AC-No', 'AC No', 'ACNo', '‡∏£‡∏´‡∏±‡∏™', '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'EmpCode']);
    const name = pick(['Name', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'Employee', 'EmpName']);
    const dept = pick(['Department', '‡πÅ‡∏ú‡∏ô‡∏Å', '‡∏ù‡πà‡∏≤‡∏¢', 'Dept']);
    const dateVal = pick(['Date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô', 'WorkDate']);
    const timeVal = pick(['Time', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏™‡πÅ‡∏Å‡∏ô', 'Scan', 'Check']);

    const date = parseThaiOrAnyDate(dateVal);
    const times = parseTimesCell(timeVal);

    return {
      acNo: acNo != null ? String(acNo).trim() : '',
      name: name != null ? String(name).trim() : '',
      dept: dept != null ? String(dept).trim() : '',
      date,
      times,
    };
  }

  function buildNote(workStatus, lateStatus, scanType) {
    const notes = [];
    if (scanType === '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥') notes.push('‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤=‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å, ‡∏≠‡∏≠‡∏Å=‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)');
    if (scanType === '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß') notes.push('‡∏Ç‡∏≤‡∏î‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å');
    if (scanType === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô') notes.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πÅ‡∏Å‡∏ô (‡∏≠‡∏≤‡∏à‡∏•‡∏≤/‡∏´‡∏¢‡∏∏‡∏î/‡∏Ç‡∏≤‡∏î)');
    if (workStatus === '0.5') notes.push('‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô');
    if (workStatus === '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' && scanType !== '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß') notes.push('‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå');
    if (lateStatus === '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô') notes.push('‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô');
    if (lateStatus === '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥') notes.push('‡∏™‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô');
    return notes.join(' | ');
  }

  function buildDaily(records, policy, workRules) {
    const map = new Map();
    for (const r of records) {
      if (!r.date) continue;
      const k = `${r.acNo}||${r.name}||${r.dept}||${keyDate(r.date)}`;
      if (!map.has(k)) map.set(k, { ...r, times: [...(r.times || [])] });
      else {
        const cur = map.get(k);
        cur.times.push(...(r.times || []));
        cur.times.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
        map.set(k, cur);
      }
    }

    const daily = [];
    for (const v of map.values()) {
      const times = v.times || [];

      let inT = null;
      let outT = null;
      let scanType = '‡∏õ‡∏Å‡∏ï‡∏¥';

      if (times.length === 0) {
        scanType = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô';
      } else if (times.length === 1) {
        scanType = '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
        inT = times[0];
        outT = times[0];
      } else {
        inT = times[0];
        outT = times[times.length - 1];
        scanType = times.length > 2 ? '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥';
      }

      let durationMin = null;
      if (times.length >= 2 && inT && outT) {
        durationMin = Math.max(0, timeToMinutes(outT) - timeToMinutes(inT));
      }

      let workStatus = '0';
      if (times.length === 0) {
        workStatus = '0';
      } else if (times.length === 1) {
        workStatus = '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
      } else {
        if (durationMin >= workRules.fullDayMin) workStatus = '1';
        else if (durationMin >= workRules.halfDayMin) workStatus = '0.5';
        else workStatus = '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
      }

      const lateStatus = scanType === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : classifyLateText(inT, policy);

      daily.push({
        '‡∏£‡∏´‡∏±‡∏™': v.acNo,
        '‡∏ä‡∏∑‡πà‡∏≠': v.name,
        '‡πÅ‡∏ú‡∏ô‡∏Å': v.dept,
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': formatDate(v.date),
        '‡πÄ‡∏Ç‡πâ‡∏≤': inT ? inT.raw : '',
        '‡∏≠‡∏≠‡∏Å': outT ? outT.raw : '',
        '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á(‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å)': durationMin != null ? minutesToHHMM(durationMin) : '',
        '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô': workStatus,
        '‡∏™‡∏≤‡∏¢': lateStatus,
        '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô': scanType,
        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': buildNote(workStatus, lateStatus, scanType),
      });
    }

    daily.sort((a, b) => (a['‡∏ä‡∏∑‡πà‡∏≠'] || '').localeCompare(b['‡∏ä‡∏∑‡πà‡∏≠'] || '', 'th') || (a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || '').localeCompare(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || ''));
    return daily;
  }

  function buildSummary(dailyRows) {
    const m = new Map();
    const inc = (o, k, v = 1) => (o[k] = (o[k] || 0) + v);

    for (const r of dailyRows) {
      const key = `${r['‡∏£‡∏´‡∏±‡∏™']}||${r['‡∏ä‡∏∑‡πà‡∏≠']}||${r['‡πÅ‡∏ú‡∏ô‡∏Å']}`;
      if (!m.has(key)) {
        m.set(key, {
          '‡∏£‡∏´‡∏±‡∏™': r['‡∏£‡∏´‡∏±‡∏™'],
          '‡∏ä‡∏∑‡πà‡∏≠': r['‡∏ä‡∏∑‡πà‡∏≠'],
          '‡πÅ‡∏ú‡∏ô‡∏Å': r['‡πÅ‡∏ú‡∏ô‡∏Å'],
          '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô=1': 0,
          '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô=0.5': 0,
          '‡∏Ç‡∏≤‡∏î/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô=0': 0,
          '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥': 0,
          '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥': 0,
          '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô': 0,
          '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥': 0,
          '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß': 0,
        });
      }
      const s = m.get(key);

      if (r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '1') inc(s, '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô=1');
      else if (r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '0.5') inc(s, '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô=0.5');
      else if (r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '0') inc(s, '‡∏Ç‡∏≤‡∏î/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô=0');
      else inc(s, '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');

      if (r['‡∏™‡∏≤‡∏¢'] === '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥') inc(s, '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥');
      if (r['‡∏™‡∏≤‡∏¢'] === '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô') inc(s, '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô');

      if (r['‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô'] === '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥') inc(s, '‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥');
      if (r['‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô'] === '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß') inc(s, '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß');

      m.set(key, s);
    }

    const out = Array.from(m.values());
    out.sort((a, b) => (b['‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'] || 0) - (a['‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'] || 0));
    return out;
  }

  function downloadXLSX({ sheetName, dailyRows, summaryRows }) {
    const wb = XLSX.utils.book_new();

    const wsDaily = XLSX.utils.json_to_sheet(dailyRows);
    XLSX.utils.book_append_sheet(wb, wsDaily, 'Daily');

    const wsSum = XLSX.utils.json_to_sheet(summaryRows);
    XLSX.utils.book_append_sheet(wb, wsSum, 'Summary');

    XLSX.writeFile(wb, `HR_Attendance_${sheetName || 'sheet'}.xlsx`);
  }

  // =====================
  // UI State
  // =====================
  const $ = (id) => document.getElementById(id);
  let wb = null;
  let currentSheet = '';
  let rawRows = [];
  let dailyRows = [];
  let summaryRows = [];
  let activeTab = 'Daily';

  function setFileName(name){
    $('fileName').textContent = name || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
  }

  function setTab(name){
    activeTab = name;
    $('tabDaily').classList.toggle('active', name === 'Daily');
    $('tabSummary').classList.toggle('active', name === 'Summary');
    renderTable();
  }

  function getPolicy(){
    return {
      start: $('start').value || '08:00',
      lateNoDeductFrom: $('lateNoDed').value || '08:01',
      lateDeductFrom: $('lateDed').value || '08:05',
    };
  }

  function getWorkRules(){
    return {
      fullDayMin: Number($('fullDayMin').value || 540),
      halfDayMin: Number($('halfDayMin').value || 240),
    };
  }

  function updateKPIs(){
    $('kRaw').textContent = rawRows.length ? String(rawRows.length) : '‚Äî';
    $('kDaily').textContent = dailyRows.length ? String(dailyRows.length) : '‚Äî';
    const people = new Set(dailyRows.map(r => `${r['‡∏£‡∏´‡∏±‡∏™']}||${r['‡∏ä‡∏∑‡πà‡∏≠']}||${r['‡πÅ‡∏ú‡∏ô‡∏Å']}`));
    $('kPeople').textContent = dailyRows.length ? String(people.size) : '‚Äî';
    const bad = dailyRows.filter(r => r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] === '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥').length;
    $('kBad').textContent = dailyRows.length ? String(bad) : '‚Äî';
  }

  function renderTable(){
    const head = $('prevHead');
    const body = $('prevBody');
    head.innerHTML='';
    body.innerHTML='';

    const rows = (activeTab === 'Daily') ? dailyRows : summaryRows;
    if(!rows.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.className='small';
      td.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå/‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó';
      td.colSpan = 12;
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    const cols = Object.keys(rows[0]);
    for(const c of cols){
      const th = document.createElement('th');
      th.textContent = c;
      head.appendChild(th);
    }

    const sample = rows.slice(0, 60);
    for(const r of sample){
      const tr = document.createElement('tr');
      for(const c of cols){
        const td = document.createElement('td');
        td.textContent = r[c] ?? '';
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }
  }

  function recompute(){
    const normalized = rawRows.map(normalizeRow);
    dailyRows = buildDaily(normalized, getPolicy(), getWorkRules());
    summaryRows = buildSummary(dailyRows);
    $('downloadBtn').disabled = dailyRows.length === 0;
    updateKPIs();
    renderTable();
  }

  function loadSheet(){
    if(!wb) return;
    currentSheet = $('sheetSelect').value;
    if(!currentSheet) return;
    const ws = wb.Sheets[currentSheet];
    rawRows = XLSX.utils.sheet_to_json(ws, { defval: null });
    recompute();
  }

  async function onPickFile(file){
    if(!file) return;
    setFileName(file.name);
    const buf = await file.arrayBuffer();
    wb = XLSX.read(buf, { type: 'array' });

    $('sheetSelect').innerHTML='';
    for(const s of wb.SheetNames){
      const opt = document.createElement('option');
      opt.value = s; opt.textContent = s;
      $('sheetSelect').appendChild(opt);
    }

    currentSheet = wb.SheetNames[0] || '';
    $('sheetSelect').value = currentSheet;
    $('sheetSelect').disabled = !currentSheet;
    $('loadSheetBtn').disabled = !currentSheet;

    loadSheet();
  }

  function downloadOneClick(){
    if(!dailyRows.length){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå/‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    downloadXLSX({ sheetName: currentSheet, dailyRows, summaryRows });
  }

  // =====================
  // Wire UI
  // =====================
  $('pickBtn').addEventListener('click', ()=> $('fileInput').click());
  $('fileInput').addEventListener('change', (e)=> onPickFile(e.target.files?.[0]));
  $('loadSheetBtn').addEventListener('click', ()=> loadSheet());
  $('downloadBtn').addEventListener('click', ()=> downloadOneClick());

  $('sheetSelect').addEventListener('change', ()=> loadSheet());

  for(const id of ['start','lateNoDed','lateDed','fullDayMin','halfDayMin']){
    $(id).addEventListener('change', ()=> recompute());
    $(id).addEventListener('keyup', ()=> recompute());
  }

  $('tabDaily').addEventListener('click', ()=> setTab('Daily'));
  $('tabSummary').addEventListener('click', ()=> setTab('Summary'));

  const dz = $('dropZone');
  dz.addEventListener('dragover', (e)=>{e.preventDefault();dz.style.borderColor='rgba(122,162,255,.75)';});
  dz.addEventListener('dragleave', ()=>{dz.style.borderColor='rgba(122,162,255,.35)';});
  dz.addEventListener('drop', (e)=>{
    e.preventDefault();
    dz.style.borderColor='rgba(122,162,255,.35)';
    const f = e.dataTransfer.files?.[0];
    if(f) onPickFile(f);
  });

  renderTable();
</script>
</body>
</html>
