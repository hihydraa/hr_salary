<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HR Attendance Cleaner</title>
  <!-- SheetJS (XLS/XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- JSZip (zip download) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#8ea0c6;--text:#e9efff;--accent:#7aa2ff;--good:#33d17a;--warn:#ffcc00;--bad:#ff5c7a;}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#070a14 100%);color:var(--text);}
    .wrap{max-width:1150px;margin:0 auto;padding:24px;}
    h1{margin:0 0 8px 0;font-size:22px;}
    p{margin:0 0 14px 0;color:var(--muted);line-height:1.45;}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(122,162,255,.18);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .drop{border:2px dashed rgba(122,162,255,.35);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:center;justify-content:space-between;}
    .drop .left{display:flex;gap:14px;align-items:center;}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(122,162,255,.12);border:1px solid rgba(122,162,255,.25);padding:6px 10px;border-radius:999px;color:var(--text);font-size:12px;}
    .btn{appearance:none;border:0;border-radius:14px;padding:10px 12px;background:var(--accent);color:#0b1020;font-weight:700;cursor:pointer;}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(122,162,255,.35);}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input,select{width:100%;padding:10px 10px;border-radius:14px;border:1px solid rgba(122,162,255,.25);background:rgba(8,12,26,.55);color:var(--text);}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    @media (max-width: 980px){.kpi{grid-template-columns:repeat(2,1fr);} .three{grid-template-columns:1fr;} .two{grid-template-columns:1fr;}}
    .kpi .box{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;}
    .kpi .n{font-size:18px;font-weight:800;margin-top:4px;}
    .tag{font-size:12px;color:var(--muted)}
    .ok{color:var(--good)} .wn{color:var(--warn)} .bd{color:var(--bad)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.08);}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px;vertical-align:top;}
    th{background:rgba(255,255,255,.04);text-align:left;color:#cfe0ff;position:sticky;top:0;}
    tr:last-child td{border-bottom:0;}
    .scroll{max-height:420px;overflow:auto;border-radius:14px;}
    .small{font-size:12px;color:var(--muted)}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢ HR: Clean ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å ‚Üí ‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ + Summary (‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</h1>
    <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå <b>.xls/.xlsx</b> ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏µ‡∏ó <code>OD(1)</code>, <code>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ-‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (1)</code>). ‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö <b>Client-side</b> ‡∏ö‡∏ô GitHub Pages ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)</p>

    <div class="grid">
      <div class="card">
        <div class="drop" id="dropZone">
          <div class="left">
            <div class="pill">üìé Drag & Drop ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            <div class="small" id="fileName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
          </div>
          <div class="row">
            <input id="fileInput" type="file" accept=".xls,.xlsx" style="display:none" />
            <button class="btn secondary" id="pickBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            <button class="btn" id="processBtn" disabled>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpi">
          <div class="box"><div class="tag">‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏ß‡∏°)</div><div class="n" id="kRows">‚Äî</div></div>
          <div class="box"><div class="tag">‡∏Ñ‡∏ô (Unique)</div><div class="n" id="kPeople">‚Äî</div></div>
          <div class="box"><div class="tag">‡∏ß‡∏±‡∏ô (Unique)</div><div class="n" id="kDays">‚Äî</div></div>
          <div class="box"><div class="tag">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="n bd" id="kBad">‚Äî</div></div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;align-items:flex-end;">
          <div>
            <div style="font-weight:800;margin-bottom:6px;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</div>
            <div class="small">‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏î‡∏≤‡πÉ‡∏´‡πâ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤</div>
          </div>
          <button class="btn" id="downloadBtn" disabled>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (ZIP)</button>
        </div>

        <div class="scroll" style="margin-top:10px;">
          <table id="previewTable">
            <thead><tr id="prevHead"></tr></thead>
            <tbody id="prevBody"><tr><td class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ)</div>

        <div class="three">
          <div>
            <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏≤‡∏¢)</label>
            <input id="startTime" type="time" value="08:00" />
          </div>
          <div>
            <label>‡∏™‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
            <input id="lateNoDed" type="time" value="08:01" />
          </div>
          <div>
            <label>‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
            <input id="lateDed" type="time" value="08:05" />
          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <label>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ = ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥)</label>
            <input id="minHours" type="number" step="0.25" value="4" />
          </div>
          <div>
            <label>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö = 1 ‡∏ß‡∏±‡∏ô)</label>
            <input id="fullDayHours" type="number" step="0.25" value="9" />
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:800;margin-bottom:8px;">‡πÅ‡∏°‡∏õ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏≤‡∏ú‡∏¥‡∏î)</div>
        <div class="small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ä‡∏µ‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‚Äù ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>

        <div style="margin-top:10px;">
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏µ‡∏ó</label>
          <select id="sheetSelect" disabled></select>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
            <select id="colName" disabled></select>
          </div>
          <div>
            <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <select id="colEmpId" disabled></select>
          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Datetime)</label>
            <select id="colDateTime" disabled></select>
          </div>
          <div>
            <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡πÅ‡∏¢‡∏Å)</label>
            <select id="colDate" disabled></select>
          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÅ‡∏¢‡∏Å)</label>
            <select id="colTime" disabled></select>
          </div>
          <div>
            <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: IN/OUT (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <select id="colInOut" disabled></select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="small">
          <div style="font-weight:800;color:#cfe0ff;margin-bottom:6px;">Logic ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ (‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô)</div>
          <ul style="margin:0;padding-left:18px;line-height:1.5;">
            <li>‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥: <b>‡πÄ‡∏Ç‡πâ‡∏≤</b>‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏£‡∏Å, <b>‡∏≠‡∏≠‡∏Å</b>‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</li>
            <li>‡∏°‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏à‡∏≤‡∏Å <b>first-in ‚Üí last-out</b></li>
            <li>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á <code>&lt; minHours</code> ‚áí <span class="bd">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span></li>
            <li>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á <code>minHours ‡∏ñ‡∏∂‡∏á &lt; fullDayHours</code> ‚áí <span class="wn">0.5 ‡∏ß‡∏±‡∏ô</span></li>
            <li>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á <code>‚â• fullDayHours</code> ‚áí <span class="ok">1 ‡∏ß‡∏±‡∏ô</span></li>
            <li>‡∏Ç‡∏≤‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡∏≤‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å ‚áí <span class="bd">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span></li>
            <li>‡∏™‡∏≤‡∏¢: ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‚â• 08:01 = <span class="wn">‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥</span>, ‚â• 08:05 = <span class="bd">‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // Utilities
  // -----------------------------
  const $ = (id) => document.getElementById(id);

  function toMinutes(t){
    if(!t) return null;
    const [hh,mm] = String(t).split(':').map(Number);
    if(Number.isNaN(hh) || Number.isNaN(mm)) return null;
    return hh*60+mm;
  }

  function pad2(n){return String(n).padStart(2,'0');}

  function formatDate(d){
    // d: Date
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function formatTime(d){
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function safeStr(v){
    if(v === null || v === undefined) return '';
    return String(v).trim();
  }

  function parseExcelDate(v){
    // SheetJS may give Date, number (excel serial), or string
    if(v instanceof Date && !isNaN(v)) return v;
    if(typeof v === 'number'){
      // Excel date serial: use SheetJS helper
      const o = XLSX.SSF.parse_date_code(v);
      if(!o) return null;
      return new Date(o.y, o.m-1, o.d, o.H||0, o.M||0, o.S||0);
    }
    if(typeof v === 'string'){
      const s = v.trim();
      if(!s) return null;
      // Try ISO / common formats
      const d = new Date(s);
      if(!isNaN(d)) return d;
      // Try DD/MM/YYYY HH:mm
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if(m){
        let dd=+m[1], mm=+m[2], yy=+m[3];
        if(yy<100) yy += 2000;
        const HH=+(m[4]||0), MM=+(m[5]||0), SS=+(m[6]||0);
        const d2 = new Date(yy, mm-1, dd, HH, MM, SS);
        if(!isNaN(d2)) return d2;
      }
    }
    return null;
  }

  function guessColumn(headers, keywords){
    // returns header string or ''
    const lower = headers.map(h=>safeStr(h).toLowerCase());
    for(const kw of keywords){
      const k = kw.toLowerCase();
      const idx = lower.findIndex(h => h.includes(k));
      if(idx>=0) return headers[idx];
    }
    return '';
  }

  function buildSelect(selectEl, headers, preferred){
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value=''; opt0.textContent='‚Äî ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‚Äî';
    selectEl.appendChild(opt0);
    for(const h of headers){
      const opt = document.createElement('option');
      opt.value = h; opt.textContent = h;
      selectEl.appendChild(opt);
    }
    selectEl.value = preferred || '';
  }

  // -----------------------------
  // App State
  // -----------------------------
  let workbook = null;
  let rawBySheet = new Map(); // sheetName -> {headers, rows}

  // Processed outputs
  let detailRows = [];
  let summaryRows = [];

  // -----------------------------
  // File handling
  // -----------------------------
  function setFileName(name){
    $('fileName').textContent = name || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
  }

  function enableMappingUI(on){
    for(const id of ['sheetSelect','colName','colEmpId','colDateTime','colDate','colTime','colInOut']){
      $(id).disabled = !on;
    }
  }

  async function readFile(file){
    const buf = await file.arrayBuffer();
    workbook = XLSX.read(buf, {type:'array', cellDates:true});

    rawBySheet.clear();
    for(const sn of workbook.SheetNames){
      const ws = workbook.Sheets[sn];
      const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:true});
      const headers = json.length ? Object.keys(json[0]) : [];
      rawBySheet.set(sn, {headers, rows: json});
    }

    // populate sheet select
    $('sheetSelect').innerHTML='';
    for(const sn of workbook.SheetNames){
      const opt = document.createElement('option');
      opt.value = sn; opt.textContent = sn;
      $('sheetSelect').appendChild(opt);
    }

    // pick best default sheet: prefer OD(1) then ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ-‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (1) else first
    const preferred = workbook.SheetNames.find(s=>s.includes('OD'))
      || workbook.SheetNames.find(s=>s.includes('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'))
      || workbook.SheetNames[0];
    $('sheetSelect').value = preferred;

    enableMappingUI(true);
    autoMapForSheet(preferred);
    $('processBtn').disabled = false;
  }

  function autoMapForSheet(sheetName){
    const pack = rawBySheet.get(sheetName);
    if(!pack){ enableMappingUI(false); return; }
    const headers = pack.headers;

    // very tolerant guesses (Thai/English)
    const gName = guessColumn(headers, ['‡∏ä‡∏∑‡πà‡∏≠', 'name', 'employee', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']);
    const gEmpId = guessColumn(headers, ['‡∏£‡∏´‡∏±‡∏™', 'empid', 'employee id', 'id']);
    const gDT = guessColumn(headers, ['datetime', '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å', 'time stamp', 'timestamp']);
    const gDate = guessColumn(headers, ['date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô']);
    const gTime = guessColumn(headers, ['time', '‡πÄ‡∏ß‡∏•‡∏≤']);
    const gInOut = guessColumn(headers, ['in/out', 'inout', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'type', 'direction']);

    buildSelect($('colName'), headers, gName);
    buildSelect($('colEmpId'), headers, gEmpId);
    buildSelect($('colDateTime'), headers, gDT);
    buildSelect($('colDate'), headers, gDate);
    buildSelect($('colTime'), headers, gTime);
    buildSelect($('colInOut'), headers, gInOut);
  }

  // -----------------------------
  // Core logic
  // -----------------------------
  function normalizeInOut(v){
    const s = safeStr(v).toLowerCase();
    if(!s) return '';
    if(s.includes('in') || s.includes('‡πÄ‡∏Ç‡πâ‡∏≤')) return 'IN';
    if(s.includes('out') || s.includes('‡∏≠‡∏≠‡∏Å')) return 'OUT';
    // some devices label as 0/1
    if(s === '0') return 'IN';
    if(s === '1') return 'OUT';
    return ''; // unknown
  }

  function extractEvents(pack, mapping){
    // Returns list of {empKey, empName, empId, dt, dateKey, inout}
    const {rows} = pack;
    const events = [];

    for(const r of rows){
      const empName = safeStr(r[mapping.colName]);
      const empId = safeStr(r[mapping.colEmpId]);
      const empKey = empId || empName || '(‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';

      // build datetime
      let dt = null;
      if(mapping.colDateTime){
        dt = parseExcelDate(r[mapping.colDateTime]);
      }
      if(!dt && mapping.colDate && mapping.colTime){
        const dPart = safeStr(r[mapping.colDate]);
        const tPart = safeStr(r[mapping.colTime]);
        dt = parseExcelDate(`${dPart} ${tPart}`);
      }
      if(!dt && mapping.colDate){
        dt = parseExcelDate(r[mapping.colDate]);
      }
      if(!dt) continue;

      const dateKey = formatDate(dt);
      const inout = mapping.colInOut ? normalizeInOut(r[mapping.colInOut]) : '';

      events.push({empKey, empName, empId, dt, dateKey, inout});
    }

    return events;
  }

  function splitInOutIfMissing(events){
    // If inout missing entirely, infer: earliest as IN, latest as OUT (per person per day)
    // This is a heuristic; anomalies are flagged.
    const by = new Map();
    for(const e of events){
      const k = `${e.empKey}__${e.dateKey}`;
      if(!by.has(k)) by.set(k, []);
      by.get(k).push(e);
    }
    const out = [];
    for(const [k, arr] of by.entries()){
      arr.sort((a,b)=>a.dt-b.dt);
      const hasIO = arr.some(x=>x.inout==='IN' || x.inout==='OUT');
      if(hasIO){
        out.push(...arr);
      }else{
        if(arr.length===1){
          // unknown single scan
          out.push({...arr[0], inout:''});
        }else{
          // infer
          out.push({...arr[0], inout:'IN'});
          for(let i=1;i<arr.length-1;i++) out.push({...arr[i], inout:'MID'});
          out.push({...arr[arr.length-1], inout:'OUT'});
        }
      }
    }
    return out;
  }

  function classifyDay(group, cfg){
    // group: events for person+day
    // returns detail row
    const dateKey = group[0].dateKey;
    const empKey = group[0].empKey;
    const empName = group[0].empName;
    const empId = group[0].empId;

    const inEvents = group.filter(e=>e.inout==='IN');
    const outEvents = group.filter(e=>e.inout==='OUT');
    const unknownIO = group.some(e=>!e.inout || e.inout==='MID');

    // Determine first-in and last-out
    let firstIn = null;
    let lastOut = null;

    if(inEvents.length){
      inEvents.sort((a,b)=>a.dt-b.dt);
      firstIn = inEvents[0].dt;
    }
    if(outEvents.length){
      outEvents.sort((a,b)=>a.dt-b.dt);
      lastOut = outEvents[outEvents.length-1].dt;
    }

    // If missing IN or OUT but we have timestamps, try fallback to min/max
    let fallbackUsed = false;
    if(!firstIn || !lastOut){
      const all = [...group].sort((a,b)=>a.dt-b.dt);
      if(!firstIn && all.length) { firstIn = all[0].dt; fallbackUsed = true; }
      if(!lastOut && all.length) { lastOut = all[all.length-1].dt; fallbackUsed = true; }
    }

    // Compute hours
    let hours = null;
    if(firstIn && lastOut){
      hours = (lastOut - firstIn) / 36e5;
      if(hours < 0) hours = null;
    }

    // Work day value
    let workValue = '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
    let anomaly = [];

    const hasOnlyOneScan = (group.length === 1);
    if(hasOnlyOneScan) anomaly.push('‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß');

    // Missing explicitly labeled IN/OUT
    if(inEvents.length===0) anomaly.push('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ (IN)');
    if(outEvents.length===0) anomaly.push('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å (OUT)');
    if(unknownIO) anomaly.push('‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ IN/OUT ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î');
    if(fallbackUsed) anomaly.push('‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ min/max ‡πÅ‡∏ó‡∏ô (‡πÄ‡∏î‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)');

    if(hours === null){
      workValue = '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
    } else {
      if(hours < cfg.minHours){
        workValue = '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
        anomaly.push(`‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ${cfg.minHours} ‡∏ä‡∏°.`);
      } else if(hours < cfg.fullDayHours){
        workValue = '0.5';
      } else {
        workValue = '1';
      }
    }

    // Late status
    let lateStatus = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
    if(firstIn){
      const inMin = firstIn.getHours()*60 + firstIn.getMinutes();
      const noDed = cfg.lateNoDed;
      const ded = cfg.lateDed;
      if(inMin >= ded) lateStatus = '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô';
      else if(inMin >= noDed) lateStatus = '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥';
      else lateStatus = '‡∏õ‡∏Å‡∏ï‡∏¥';
    } else {
      lateStatus = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤';
    }

    // Scan behavior summary
    const scanInCount = inEvents.length;
    const scanOutCount = outEvents.length;
    let scanNote = [];
    if(scanInCount > 1) scanNote.push(`‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ ${scanInCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏£‡∏Å)`);
    if(scanOutCount > 1) scanNote.push(`‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å ${scanOutCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)`);
    if(!scanNote.length && group.length>2) scanNote.push(`‡∏™‡πÅ‡∏Å‡∏ô ${group.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);

    // Absence / leave: cannot know without leave table, so mark "0" only if explicit policy provided.
    // We keep 0 only when there are no scans for that day (not present in data). This requires date range.

    return {
      sheet: group[0].sheet,
      empId,
      empName,
      date: dateKey,
      first_in: firstIn ? formatTime(firstIn) : '',
      last_out: lastOut ? formatTime(lastOut) : '',
      work_hours: (hours===null?'':Math.round(hours*100)/100),
      work_value: workValue, // 1 / 0.5 / ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
      late: lateStatus,
      scan_in_count: scanInCount,
      scan_out_count: scanOutCount,
      scan_total: group.length,
      scan_note: scanNote.join(' | '),
      anomaly: anomaly.join(' | ')
    };
  }

  function buildSummary(detail){
    // by employee (and sheet)
    const by = new Map();
    for(const r of detail){
      const k = `${r.sheet}__${(r.empId||r.empName)}`;
      if(!by.has(k)) by.set(k, {sheet:r.sheet, empId:r.empId, empName:r.empName,
        days:0, day_1:0, day_half:0, abnormal:0,
        late_normal:0, late_deduct:0, normal:0, other_late:0
      });
      const s = by.get(k);
      s.days += 1;
      if(r.work_value === '1') s.day_1 += 1;
      else if(r.work_value === '0.5') s.day_half += 1;
      else s.abnormal += 1;

      if(r.late === '‡∏õ‡∏Å‡∏ï‡∏¥') s.normal += 1;
      else if(r.late === '‡∏™‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥') s.late_normal += 1;
      else if(r.late === '‡∏™‡∏≤‡∏¢‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô') s.late_deduct += 1;
      else s.other_late += 1;
    }
    return Array.from(by.values());
  }

  function updateKPIs(){
    $('kRows').textContent = String(detailRows.length || '‚Äî');
    const people = new Set(detailRows.map(r => (r.empId||r.empName||'').trim()).filter(Boolean));
    const days = new Set(detailRows.map(r => r.date));
    const bad = detailRows.filter(r => r.work_value === '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥').length;
    $('kPeople').textContent = people.size ? String(people.size) : '‚Äî';
    $('kDays').textContent = days.size ? String(days.size) : '‚Äî';
    $('kBad').textContent = detailRows.length ? String(bad) : '‚Äî';
  }

  function renderPreview(){
    const cols = ['sheet','empId','empName','date','first_in','last_out','work_hours','work_value','late','scan_note','anomaly'];
    const head = $('prevHead');
    head.innerHTML = '';
    for(const c of cols){
      const th = document.createElement('th');
      th.textContent = c;
      head.appendChild(th);
    }

    const body = $('prevBody');
    body.innerHTML = '';
    const sample = detailRows.slice(0, 30);
    if(!sample.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = cols.length;
      td.className='small';
      td.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    for(const r of sample){
      const tr = document.createElement('tr');
      for(const c of cols){
        const td = document.createElement('td');
        td.textContent = r[c] ?? '';
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }
  }

  // -----------------------------
  // Export
  // -----------------------------
  function sheetFromObjects(objs){
    return XLSX.utils.json_to_sheet(objs);
  }

  function buildWorkbook(detail, summary){
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, sheetFromObjects(detail), 'DETAIL');
    XLSX.utils.book_append_sheet(wb, sheetFromObjects(summary), 'SUMMARY');
    return wb;
  }

  async function downloadZip(){
    const zip = new JSZip();

    // Excel
    const wb = buildWorkbook(detailRows, summaryRows);
    const xlsxData = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    zip.file('attendance_detail_and_summary.xlsx', xlsxData);

    // CSVs for compatibility
    const detailCsv = XLSX.utils.sheet_to_csv(sheetFromObjects(detailRows));
    const summaryCsv = XLSX.utils.sheet_to_csv(sheetFromObjects(summaryRows));
    zip.file('DETAIL.csv', detailCsv);
    zip.file('SUMMARY.csv', summaryCsv);

    const blob = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `HR_Attendance_${new Date().toISOString().slice(0,10)}.zip`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // -----------------------------
  // Main processing action
  // -----------------------------
  function getConfig(){
    return {
      startTime: toMinutes($('startTime').value) ?? 8*60,
      lateNoDed: toMinutes($('lateNoDed').value) ?? (8*60+1),
      lateDed: toMinutes($('lateDed').value) ?? (8*60+5),
      minHours: Number($('minHours').value || 4),
      fullDayHours: Number($('fullDayHours').value || 9)
    };
  }

  function getMapping(){
    return {
      sheet: $('sheetSelect').value,
      colName: $('colName').value,
      colEmpId: $('colEmpId').value,
      colDateTime: $('colDateTime').value,
      colDate: $('colDate').value,
      colTime: $('colTime').value,
      colInOut: $('colInOut').value
    };
  }

  function processAll(){
    if(!workbook) return;

    const cfg = getConfig();

    // We will process ALL sheets, but prioritize those likely relevant.
    const targetSheets = workbook.SheetNames
      .filter(sn => /OD\(1\)|‡∏ö‡∏±‡∏ç‡∏ä‡∏µ-‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•\s*\(1\)/.test(sn))
      .concat(workbook.SheetNames.filter(sn => !/OD\(1\)|‡∏ö‡∏±‡∏ç‡∏ä‡∏µ-‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•\s*\(1\)/.test(sn)));

    const allDetail = [];

    for(const sn of targetSheets){
      const pack = rawBySheet.get(sn);
      if(!pack || !pack.rows.length) continue;

      // If user selected mapping sheet, use that mapping only for that sheet; otherwise auto map per sheet.
      const mapping = (sn === $('sheetSelect').value)
        ? getMapping()
        : (() => {
            const headers = pack.headers;
            return {
              sheet: sn,
              colName: guessColumn(headers, ['‡∏ä‡∏∑‡πà‡∏≠','name','employee','‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']),
              colEmpId: guessColumn(headers, ['‡∏£‡∏´‡∏±‡∏™','empid','employee id','id']),
              colDateTime: guessColumn(headers, ['datetime','‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤','‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å','time stamp','timestamp']),
              colDate: guessColumn(headers, ['date','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏ß‡∏±‡∏ô']),
              colTime: guessColumn(headers, ['time','‡πÄ‡∏ß‡∏•‡∏≤']),
              colInOut: guessColumn(headers, ['in/out','inout','‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','type','direction'])
            };
          })();

      // Must have at least name/id and datetime (or date+time)
      if(!mapping.colName && !mapping.colEmpId) continue;
      if(!mapping.colDateTime && !(mapping.colDate && mapping.colTime) && !mapping.colDate) continue;

      let events = extractEvents(pack, mapping);
      // attach sheet
      events = events.map(e => ({...e, sheet: sn}));
      events = splitInOutIfMissing(events);

      // group by person+day
      const by = new Map();
      for(const e of events){
        const k = `${e.empKey}__${e.dateKey}`;
        if(!by.has(k)) by.set(k, []);
        by.get(k).push(e);
      }

      for(const arr of by.values()){
        arr.sort((a,b)=>a.dt-b.dt);
        allDetail.push(classifyDay(arr, cfg));
      }
    }

    // Sort output for HR readability
    allDetail.sort((a,b)=>{
      const ak = `${a.sheet}|${a.empName}|${a.date}`;
      const bk = `${b.sheet}|${b.empName}|${b.date}`;
      return ak.localeCompare(bk, 'th');
    });

    detailRows = allDetail;
    summaryRows = buildSummary(detailRows);

    updateKPIs();
    renderPreview();

    $('downloadBtn').disabled = detailRows.length === 0;
  }

  // -----------------------------
  // Events
  // -----------------------------
  $('pickBtn').addEventListener('click', () => $('fileInput').click());
  $('fileInput').addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    setFileName(f.name);
    await readFile(f);
  });

  const dz = $('dropZone');
  dz.addEventListener('dragover', (e)=>{e.preventDefault();dz.style.borderColor='rgba(122,162,255,.75)';});
  dz.addEventListener('dragleave', ()=>{dz.style.borderColor='rgba(122,162,255,.35)';});
  dz.addEventListener('drop', async (e)=>{
    e.preventDefault();
    dz.style.borderColor='rgba(122,162,255,.35)';
    const f = e.dataTransfer.files?.[0];
    if(!f) return;
    setFileName(f.name);
    $('fileInput').value = '';
    await readFile(f);
  });

  $('sheetSelect').addEventListener('change', (e)=>{
    autoMapForSheet(e.target.value);
  });

  $('processBtn').addEventListener('click', ()=>{
    processAll();
  });

  $('downloadBtn').addEventListener('click', async ()=>{
    await downloadZip();
  });

  // If user changes mapping or config after processing, they can just press process again.
</script>
</body>
</html>
